<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega QR StÃ¼dyo (Mobil Uyumlu)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #0d0d0d;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .panel {
            background: #181818;
            padding: 25px;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            border: 1px solid #333;
            box-shadow: 0 10px 50px rgba(0,0,0,0.9);
        }

        h2 { text-align: center; color: #ffdd00; margin-top: 0; text-transform: uppercase; letter-spacing: 2px;}

        .upload-area {
            border: 2px dashed #444; padding: 15px; text-align: center; margin-top: 15px; border-radius: 12px; cursor: pointer; transition: 0.3s;
            background-color: #222;
        }
        .upload-area:hover { border-color: #ffdd00; background-color: #2a2a2a; }

        input[type="file"] { display: none; }
        input[type="range"] { width: 100%; margin-top: 10px; accent-color: #ffdd00; cursor: pointer; }

        label { display: block; margin-top: 15px; font-weight: bold; color: #ccc; font-size: 0.9rem;}
        input[type="text"], select {
            width: 100%; padding: 12px; background: #2d2d2d; border: 1px solid #444;
            color: #fff; border-radius: 8px; margin-top: 5px; font-size: 16px; box-sizing: border-box;
        }
        input[type="color"] { height: 50px; width:100%; padding: 0; border: none; cursor: pointer; }

        #emoji { text-align: center; font-size: 24px; letter-spacing: 5px; }

        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        button {
            width: 100%; padding: 18px; margin-top: 25px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: 0.2s;
        }
        .btn-gen { background: linear-gradient(45deg, #ffdd00, #ffbb00); color: #000; }
        .btn-gen:hover { transform: scale(1.02); }
        .btn-dl { background: linear-gradient(45deg, #ff0055, #cc0044); color: #fff; display: none; }

        #previewContainer {
            margin-top: 20px; background: #fff; padding: 10px;
            border-radius: 8px; display: none; text-align: center;
            border: 2px solid #ffdd00;
        }
        canvas { max-width: 100%; height: auto; display: block; }

        .pdf-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #444;
        }
        .btn-pdf {
            background: linear-gradient(45deg, #e63946, #d62828);
            color: white;
        }
        .btn-jpg {
            background: linear-gradient(45deg, #2a9d8f, #1f7a70);
            color: white;
        }
        .hint {
            text-align:center;
            font-size:0.75rem;
            color:#aaa;
            margin-top:8px;
            line-height:1.35;
        }
    </style>
</head>
<body>

<div class="panel">
    <h2>MEGA QR STÃœDYO</h2>
    <div style="text-align:center; font-size:0.8rem; color:#777;">42x32 Sayfa / Saf Emoji Modu (Teknik Kareler Yok)</div>

    <label>ğŸ”— Link:</label>
    <input type="text" id="url" value="https://instagram.com">

    <label>ğŸ–¼ï¸ Arka Plan Resmi:</label>
    <div class="upload-area" onclick="document.getElementById('bgInput').click()">
        <div class="upload-text">Resim SeÃ§</div>
    </div>
    <input type="file" id="bgInput" accept="image/*" onchange="handleImage(event)">

    <label>Resim GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼: <span id="opVal">80%</span></label>
    <input type="range" id="bgOpacity" min="0" max="95" value="80" oninput="updateOpacityLabel(this.value)">

    <div class="row">
        <div class="col">
            <label>ğŸ˜€ Emoji:</label>
            <input type="text" id="emoji" value="ğŸ¦">
        </div>
        <div class="col">
            <label>ğŸ¨ Renk:</label>
            <input type="color" id="color" value="#000000">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>ğŸ”² DÄ±ÅŸ Ã‡erÃ§eve:</label>
            <select id="frame">
                <option value="leaf">ğŸƒ Yaprak</option>
                <option value="square">â¬› Kare</option>
                <option value="rounded">ğŸ”² YumuÅŸak</option>
                <option value="circle">âš« Yuvarlak</option>
                <option value="diamond">ğŸ’ Elmas</option>
                <option value="octagon">ğŸ›‘ Sekizgen</option>
            </select>
        </div>
        <div class="col">
            <label>âš« Ä°Ã§ Nokta:</label>
            <select id="dot">
                <option value="square">â¬› Kare</option>
                <option value="circle">âš« Yuvarlak</option>
                <option value="diamond">ğŸ’ Elmas</option>
                <option value="star">â­ YÄ±ldÄ±z</option>
            </select>
        </div>
    </div>

    <button class="btn-gen" onclick="generate()">âœ¨ DESENÄ° OLUÅTUR</button>

    <div id="previewContainer">
        <canvas id="previewCanvas"></canvas>
        <div id="uidDisplay" style="font-size:10px; color:#333; margin-top:5px;"></div>
    </div>

    <button class="btn-dl" id="dlBtn" onclick="downloadUpscaledPrintJPG()">ğŸ’¾ 42x32cm JPEG Ä°NDÄ°R (40x30 + 2mm pay)</button>

    <div class="pdf-section">
        <h3 style="text-align:center; color:#e63946; margin-bottom: 5px;">ğŸ–¨ï¸ MATBAA MODÃœLÃœ (PDF / JPEG)</h3>
        <div class="hint">YÃ¼klediÄŸin resmi otomatik 40x30cm'e getirir. Her kenarda 2mm beyaz boÅŸluk bÄ±rakÄ±r (istersen 1mm).</div>

        <label>ğŸ–¼ï¸ BaskÄ± Ä°Ã§in Resim YÃ¼kle:</label>
        <div class="upload-area" onclick="document.getElementById('pdfInput').click()" style="border-color:#e63946;">
            <div class="upload-text" id="pdfText" style="color:#e63946;">ğŸ“‚ Resim SeÃ§ (.jpg / .png)</div>
        </div>
        <input type="file" id="pdfInput" accept="image/*" onchange="handlePdfSelect(event)">

        <button class="btn-pdf" onclick="generatePDF()">ğŸ“„ PDF OLARAK KAYDET (42x32 / 40x30 OrtalÄ±)</button>

        <button class="btn-jpg" onclick="downloadUploadedAs4030JPG()">ğŸ–¼ï¸ 40x30 JPEG Ä°NDÄ°R (2mm pay)</button>
    </div>
</div>

<script>
    // =========================
    // Ã–LÃ‡ÃœLER / DÃ–NÃœÅÃœM
    // =========================
    // 300 DPI yaklaÅŸÄ±k px/cm
    const DPI = 118.11;

    // Sayfa: 42x32 cm
    const PAGE_W = Math.round(42 * DPI);
    const PAGE_H = Math.round(32 * DPI);

    // BaskÄ± alanÄ±: 40x30 cm
    const PRINT_W = Math.round(40 * DPI);
    const PRINT_H = Math.round(30 * DPI);

    // 42x32 iÃ§inde ortalama
    const MARGIN_X = (PAGE_W - PRINT_W) / 2;
    const MARGIN_Y = (PAGE_H - PRINT_H) / 2;

    // 1-2mm beyaz boÅŸluk (istediÄŸin gibi 1 yapabilirsin)
    const INNER_MARGIN_MM = 2; // 1 veya 2
    const INNER_MARGIN_PX = Math.round((INNER_MARGIN_MM / 10) * DPI); // mm -> cm -> px

    // =========================
    // QR SÄ°STEMÄ° DEÄÄ°ÅKENLER
    // =========================
    let qrData = null;
    let bgImgObj = null;
    let currentUID = "";

    // YÃ¼klenen resim (PDF/JPEG modÃ¼lÃ¼ iÃ§in)
    let pdfImgData = null;
    let uploadedImgObj = null;

    // =========================
    // ARKA PLAN YÃœKLEME
    // =========================
    function handleImage(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                bgImgObj = new Image();
                bgImgObj.onload = () => {
                    document.querySelector('.upload-text').innerText = "âœ… " + file.name;
                    document.querySelector('.upload-area').style.borderColor = "#ffdd00";
                    // Resim yÃ¼klendiÄŸinde otomatik olarak generate edelim ki kullanÄ±cÄ± hemen gÃ¶rsÃ¼n
                    // generate(); // Ä°stersen aÃ§abilirsin
                };
                bgImgObj.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    function updateOpacityLabel(val) {
        document.getElementById('opVal').innerText = val + '%';
        // CanlÄ± Ã¶nizleme iÃ§in (eÄŸer generate yapÄ±lmÄ±ÅŸsa tekrar Ã§iz)
        if(qrData) {
           let canvas = document.getElementById("previewCanvas");
           // KÃ¼Ã§Ã¼k Ã¶nizleme Ã¶lÃ§eÄŸi
           drawArt(canvas, canvas.width, canvas.height); 
        }
    }

    // =========================
    // QR OLUÅTURMA
    // =========================
    function isFinderPattern(r, c, count) {
        return (r < 7 && c < 7) || (r < 7 && c >= count - 7) || (r >= count - 7 && c < 7);
    }

    function generate() {
        let url = document.getElementById("url").value;
        if (!url) return alert("Link giriniz!");

        let uid = Math.random().toString(36).substr(2, 6).toUpperCase();
        currentUID = uid;
        let finalUrl = url.includes("?") ? `${url}&id=${uid}` : `${url}?id=${uid}`;

        let qr = qrcode(0, 'L');
        qr.addData(finalUrl);
        qr.make();
        qrData = qr;

        let canvas = document.getElementById("previewCanvas");
        let scale = 0.15;
        // Canvas boyutlarÄ±nÄ± ayarla
        canvas.width = PAGE_W * scale;
        canvas.height = PAGE_H * scale;

        drawArt(canvas, PAGE_W * scale, PAGE_H * scale);

        document.getElementById("uidDisplay").innerText = "ID: " + uid;
        document.getElementById("previewContainer").style.display = "block";
        document.getElementById("dlBtn").style.display = "block";
    }

    // =========================
    // Ã–NÄ°ZLEME Ã‡Ä°ZÄ°MÄ° (MEVCUT)
    // =========================
    function drawArt(canvas, w, h) {
        let ctx = canvas.getContext("2d");
        
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, w, h);

        let scaleFactor = w / PAGE_W;
        let printAreaX = MARGIN_X * scaleFactor;
        let printAreaY = MARGIN_Y * scaleFactor;
        let printAreaW = PRINT_W * scaleFactor;
        let printAreaH = PRINT_H * scaleFactor;

        // ARKA PLAN RESMÄ° Ã‡Ä°ZÄ°MÄ°
        if (bgImgObj) {
            ctx.save();
            ctx.drawImage(bgImgObj, 0, 0, w, h);
            
            // BeyazlÄ±k/ParlaklÄ±k efekti
            let opacity = document.getElementById("bgOpacity").value / 100;
            // Opacity 100 ise resim tam gÃ¶rÃ¼nÃ¼r (alpha 0). 0 ise tam beyaz (alpha 1).
            ctx.fillStyle = `rgba(255, 255, 255, ${1 - opacity})`;
            ctx.fillRect(0, 0, w, h);
            
            ctx.restore();
        }

        let count = qrData.getModuleCount();
        let tileW = printAreaW / count;
        let tileH = printAreaH / count;

        let mainColor = document.getElementById("color").value;
        let emojiChar = document.getElementById("emoji").value || "â¬›";
        let frameStyle = document.getElementById("frame").value;
        let dotStyle = document.getElementById("dot").value;

        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = `${tileH * 0.92}px "Segoe UI Emoji", Arial, sans-serif`;

        for (let r = 0; r < count; r++) {
            for (let c = 0; c < count; c++) {
                if (qrData.isDark(r, c)) {
                    if (isFinderPattern(r, c, count)) continue;

                    let x = printAreaX + c * tileW + tileW / 2;
                    let y = printAreaY + r * tileH + tileH / 2;
                    ctx.fillStyle = mainColor;
                    ctx.fillText(emojiChar, x, y, tileW);
                }
            }
        }

        drawLargeFinders(ctx, printAreaX, printAreaY, tileW, tileH, count, mainColor, frameStyle, dotStyle);
    }

    function drawLargeFinders(ctx, startX, startY, tileW, tileH, count, color, frameStyle, dotStyle) {
        let fw = tileW * 7;
        let fh = tileH * 7;
        let pos = [{r: 0, c: 0}, {r: 0, c: count - 7}, {r: count - 7, c: 0}];

        ctx.fillStyle = color;
        pos.forEach(p => {
            let px = startX + p.c * tileW;
            let py = startY + p.r * tileH;
            drawFinderElement(ctx, px, py, fw, fh, tileW, tileH, color, frameStyle, dotStyle);
        });
    }

    function drawFinderElement(ctx, px, py, fw, fh, tileW, tileH, color, frameStyle, dotStyle) {
        ctx.save();
        ctx.fillStyle = color;
        drawCustomRect(ctx, px, py, fw, fh, frameStyle);
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        drawCustomRect(ctx, px + tileW, py + tileH, fw - tileW * 2, fh - tileH * 2, frameStyle);
        ctx.fillStyle = color;
        drawCustomRect(ctx, px + tileW * 2, py + tileH * 2, fw - tileW * 4, fh - tileH * 4, dotStyle);
        ctx.restore();
    }

    function drawCustomRect(ctx, x, y, w, h, style) {
        ctx.beginPath();
        let r = Math.min(w, h) / 2;

        if (style === "square") { ctx.rect(x, y, w, h); }
        else if (style === "rounded") { ctx.roundRect(x, y, w, h, r * 0.4); }
        else if (style === "circle") { ctx.roundRect(x, y, w, h, r); }
        else if (style === "leaf") { ctx.roundRect(x, y, w, h, [r, 0, r, 0]); }
        else if (style === "diamond") {
            ctx.moveTo(x + w / 2, y); ctx.lineTo(x + w, y + h / 2);
            ctx.lineTo(x + w / 2, y + h); ctx.lineTo(x, y + h / 2);
        }
        else if (style === "octagon") {
            let side = w * 0.3;
            ctx.moveTo(x + side, y); ctx.lineTo(x + w - side, y);
            ctx.lineTo(x + w, y + side); ctx.lineTo(x + w, y + h - side);
            ctx.lineTo(x + w - side, y + h); ctx.lineTo(x + side, y + h);
            ctx.lineTo(x, y + h - side); ctx.lineTo(x, y + side);
        }
        else if (style === "star") {
            ctx.moveTo(x + w / 2, y);
            ctx.quadraticCurveTo(x + w / 2, y + h / 2, x + w, y + h / 2);
            ctx.quadraticCurveTo(x + w / 2, y + h / 2, x + w / 2, y + h);
            ctx.quadraticCurveTo(x + w / 2, y + h / 2, x, y + h / 2);
            ctx.quadraticCurveTo(x + w / 2, y + h / 2, x + w / 2, y);
        }
        ctx.fill();
    }

    // ==========================================================
    // MODIFIED: UPSCALE/JPEG Ã‡IKTI
    // ==========================================================
    function renderQRPrintPageToCanvas(canvas) {
        if (!qrData) {
            alert("Ã–nce DESENÄ° OLUÅTUR (QR Ã¼ret)!");
            return false;
        }

        const ctx = canvas.getContext("2d");
        canvas.width = PAGE_W;
        canvas.height = PAGE_H;

        // 1) Sayfa zemini beyaz
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, PAGE_W, PAGE_H);

        // 2) Arka plan resmi (varsa) tÃ¼m sayfaya bas + parlaklÄ±k/opacity
        if (bgImgObj) {
            ctx.save();
            ctx.drawImage(bgImgObj, 0, 0, PAGE_W, PAGE_H);
            const opacity = document.getElementById("bgOpacity").value / 100;
            ctx.fillStyle = `rgba(255, 255, 255, ${1 - opacity})`;
            ctx.fillRect(0, 0, PAGE_W, PAGE_H);
            ctx.restore();
        }

        // 3) BaskÄ± alanÄ± koordinatlarÄ±
        const printX = Math.round(MARGIN_X);
        const printY = Math.round(MARGIN_Y);

        const innerX = printX + INNER_MARGIN_PX;
        const innerY = printY + INNER_MARGIN_PX;
        const innerW = PRINT_W - 2 * INNER_MARGIN_PX;
        const innerH = PRINT_H - 2 * INNER_MARGIN_PX;

        // --- DÃœZELTME BAÅLANGIÃ‡ ---
        // ESKÄ° KOD HATASI: ctx.fillRect(printX, printY, PRINT_W, PRINT_H); -> Bu kod resmi kapatÄ±yordu.
        // YENÄ° KOD: Sadece resim YOKSA beyaz zemin at. Resim varsa dokunma.
        if (!bgImgObj) {
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(printX, printY, PRINT_W, PRINT_H);
        }
        // --- DÃœZELTME BÄ°TÄ°Å ---

        const count = qrData.getModuleCount();
        const tileW = innerW / count;
        const tileH = innerH / count;

        const mainColor = document.getElementById("color").value;
        const emojiChar = document.getElementById("emoji").value || "â¬›";
        const frameStyle = document.getElementById("frame").value;
        const dotStyle = document.getElementById("dot").value;

        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = `${tileH * 0.92}px "Segoe UI Emoji", Arial, sans-serif`;

        for (let r = 0; r < count; r++) {
            for (let c = 0; c < count; c++) {
                if (qrData.isDark(r, c)) {
                    if (isFinderPattern(r, c, count)) continue;

                    const x = innerX + c * tileW + tileW / 2;
                    const y = innerY + r * tileH + tileH / 2;
                    ctx.fillStyle = mainColor;
                    ctx.fillText(emojiChar, x, y, tileW);
                }
            }
        }

        // Finder'lar
        drawLargeFinders(ctx, innerX, innerY, tileW, tileH, count, mainColor, frameStyle, dotStyle);
        return true;
    }

    function downloadUpscaledPrintJPG() {
        const btn = document.getElementById("dlBtn");
        btn.innerText = "â³ HAZIRLANIYOR...";

        setTimeout(() => {
            const bigCanvas = document.createElement("canvas");
            const ok = renderQRPrintPageToCanvas(bigCanvas);
            if (!ok) {
                btn.innerText = "ğŸ’¾ 42x32cm JPEG Ä°NDÄ°R (40x30 + 2mm pay)";
                return;
            }

            const link = document.createElement('a');
            link.download = `MegaQR_42x32_${INNER_MARGIN_MM}mmPay_${currentUID || "NOID"}.jpg`;
            link.href = bigCanvas.toDataURL("image/jpeg", 0.95);
            link.click();

            btn.innerText = "âœ… Ä°NDÄ°RÄ°LDÄ°";
            setTimeout(() => btn.innerHTML = `ğŸ’¾ 42x32cm JPEG Ä°NDÄ°R (40x30 + 2mm pay)`, 3000);
        }, 350);
    }

    // ==========================================
    // PDF/JPEG MODÃœLÃœ: RESÄ°M SEÃ‡Ä°MÄ°
    // ==========================================
    function handlePdfSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
            // PDF iÃ§in base64
            pdfImgData = evt.target.result;

            // JPEG Ã§Ä±ktÄ±sÄ± iÃ§in Image objesi
            uploadedImgObj = new Image();
            uploadedImgObj.onload = () => {
                document.getElementById('pdfText').innerText = "âœ… " + file.name + " (HazÄ±r)";
                document.querySelector('.upload-area[onclick*="pdfInput"]').style.borderColor = "#e63946";
            };
            uploadedImgObj.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    }

    // ==========================================
    // PDF: 42x32 iÃ§inde 40x30 ortalÄ± (MEVCUT)
    // ==========================================
    async function generatePDF() {
        if (!pdfImgData) {
            alert("Ã–nce baskÄ± iÃ§in bir resim yÃ¼klemelisiniz!");
            return;
        }

        const btn = document.querySelector(".btn-pdf");
        const originalText = btn.innerText;
        btn.innerText = "â³ PDF HAZIRLANIYOR...";

        try {
            const { jsPDF } = window.jspdf;

            // 42cm x 32cm
            const doc = new jsPDF('l', 'cm', [42, 32]);

            // 40x30 ortalÄ±: x=1, y=1 (42-40=2cm => her yanda 1cm)
            doc.addImage(pdfImgData, 'JPEG', 1, 1, 40, 30);

            const pdfBlob = doc.output('blob');

            let timeStamp = new Date().toISOString().slice(0, 10);
            let fileName = `Baski_40x30_${timeStamp}.pdf`;

            const file = new File([pdfBlob], fileName, { type: "application/pdf" });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: 'QR BaskÄ± DosyasÄ±',
                    text: '40x30cm BaskÄ± iÃ§in PDF dosyanÄ±z hazÄ±r.',
                });
            } else {
                doc.save(fileName);
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                alert("Bir hata oluÅŸtu: " + err.message);
            }
        } finally {
            btn.innerText = originalText;
        }
    }

    // ==========================================
    // NEW: JPEG - YÃ¼klenen resmi 40x30'a Ã§evir + 2mm pay
    // ==========================================
    function renderUploadedTo4030Canvas(canvas) {
        if (!uploadedImgObj) {
            alert("Ã–nce bir resim seÃ§melisin!");
            return false;
        }

        const ctx = canvas.getContext("2d");
        canvas.width = PRINT_W;
        canvas.height = PRINT_H;

        // Zemin beyaz
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, PRINT_W, PRINT_H);

        // Ä°Ã§ alan (2mm pay)
        const innerX = INNER_MARGIN_PX;
        const innerY = INNER_MARGIN_PX;
        const innerW = PRINT_W - 2 * INNER_MARGIN_PX;
        const innerH = PRINT_H - 2 * INNER_MARGIN_PX;

        // Resmi iÃ§ alana TAM doldur (esneterek)
        ctx.drawImage(uploadedImgObj, innerX, innerY, innerW, innerH);
        return true;
    }

    function downloadUploadedAs4030JPG() {
        const btn = document.querySelector(".btn-jpg");
        const originalText = btn.innerText;

        if (!uploadedImgObj) {
            alert("Ã–nce bir resim seÃ§melisin!");
            return;
        }

        btn.innerText = "â³ HAZIRLANIYOR...";

        setTimeout(() => {
            const canvas = document.createElement("canvas");
            const ok = renderUploadedTo4030Canvas(canvas);
            if (!ok) {
                btn.innerText = originalText;
                return;
            }

            const a = document.createElement("a");
            const stamp = new Date().toISOString().slice(0, 10);
            a.download = `Baski_40x30_${INNER_MARGIN_MM}mmPay_${stamp}.jpg`;
            a.href = canvas.toDataURL("image/jpeg", 0.95);
            a.click();

            btn.innerText = "âœ… Ä°NDÄ°RÄ°LDÄ°";
            setTimeout(() => (btn.innerText = originalText), 2500);
        }, 250);
    }
</script>
</body>
</html>
